{"id":"nls-finetune-scix-16z","title":"Phase 2: Data ingestion + synthetic NL generation","description":"Create ingest_ads_queries.py for curated JSON. Update generate_nl.py prompt for researcher-style queries, ban ADS syntax leakage (author:, abs:, pubdate:, etc.). Build first dataset: 2k-5k valid pairs + 500 gold eval examples covering all ADS features. Focus on curated + synthetic initially (query logs later).","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-20T17:26:54.717837-05:00","created_by":"sjarmak","updated_at":"2026-01-20T21:14:34.013596-05:00","closed_at":"2026-01-20T21:14:34.013596-05:00","close_reason":"Phase 2 complete: Updated generate_nl.py to use ADS-specific prompts from domains/scix/prompts.py. Created 96 gold examples covering all FIELD_CATEGORIES (author, content, publication, identifiers, metrics, affiliation, astronomy, properties, compound). Script now imports NL_GENERATION_PROMPT and validate_nl from domain module, uses ADS_SYNTAX_MARKERS for leakage detection.","dependencies":[{"issue_id":"nls-finetune-scix-16z","depends_on_id":"nls-finetune-scix-92o","type":"blocks","created_at":"2026-01-20T17:26:54.720971-05:00","created_by":"daemon"}]}
{"id":"nls-finetune-scix-2ad","title":"Process fix: Prevent false-positive Playwright tests","description":"## Problem\nPlaywright tests 'passed' but were actually being SKIPPED because:\n1. `NEXT_PUBLIC_NL_SEARCH` wasn't set in `.env.local`\n2. Tests used `test.skip()` when component wasn't visible\n3. Build error (missing react-icons) went undetected\n\n## Recommendations\n\n### 1. Add build check before e2e tests\n```yaml\n# In CI or test script\npnpm build \u0026\u0026 pnpm test:e2e\n```\n\n### 2. Don't silently skip feature-gated tests\n```typescript\n// Bad: silently skips\nif (!isVisible) { test.skip(true, 'Feature not enabled'); }\n\n// Better: fail if feature is expected\nawait expect(nlInput).toBeVisible({ timeout: 5000 });\n```\n\n### 3. Require feature flag in CI\n```yaml\nenv:\n  NEXT_PUBLIC_NL_SEARCH: enabled\n```\n\n### 4. Add eslint-plugin-import for unresolved imports\n```json\n\"import/no-unresolved\": \"error\"\n```\n\n## Already Fixed\n- Replaced react-icons with chakra-ui icon (commit 3efe54a4)\n- Added NEXT_PUBLIC_NL_SEARCH=enabled to .env.local","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-21T11:21:06.480946-05:00","created_by":"sjarmak","updated_at":"2026-01-21T11:21:06.480946-05:00"}
{"id":"nls-finetune-scix-3gw","title":"Model hallucinates author initials - needs retraining","description":"## Problem\nThe fine-tuned model incorrectly guesses author initials instead of using safe formats.\n\n## Examples\n\n| Input | Model Output | Expected |\n|-------|--------------|----------|\n| \"papers by\" | `author:\"^b.\"` | (should require more input or error) |\n| \"papers by kelbert\" | `author:\"kelbert, m.\"` | `author:kelbert` or `author:\"^kelbert\"` |\n| \"papers by jarmak\" | `author:\"jarmak, b.\"` | `author:jarmak` or `author:\"^jarmak\"` |\n\n## Training Data Analysis\n\nLooking at `data/datasets/processed/train.jsonl`:\n\n**Good examples (no hallucinated initials):**\n- \"papers by Lyman from 2016\" → `author:\"^Lyman\"` ✅\n- \"papers by Wang 2022\" → `author:(\"^wang\")` ✅\n- \"papers by Janssens from 2023\" → `author:\"^Janssens\"` ✅\n\n**Problematic examples (initials were in input):**\n- \"papers by proctor published 2000 to 2015\" → `author:(\"proctor, r. n.\")` (where did r.n. come from?)\n- \"papers by stubbs c 2022\" → `author:(\"stubbs, c\")` (c was in input, OK)\n\n## Root Cause\n1. Some gold examples have specific author formats with initials\n2. Model learned to predict initials as a pattern even when not provided\n3. The `^b.` for just \"papers by\" suggests model treating \"by\" as initial \"b.\"\n\n## Recommended Fixes\n\n### Option A: Training Data Cleanup\n1. Audit gold_examples.json for author queries\n2. Remove or fix examples that add unprovided initials\n3. Add explicit examples: lastname only → `author:\"^lastname\"`\n\n### Option B: Post-Processing\nAdd validation in `nl-search.ts`:\n```typescript\n// If input has no initial, strip initials from output\nif (\\!input.match(/\\b[A-Z]\\./)) {\n  query = query.replace(/, [a-z]\\./, '');\n}\n```\n\n### Option C: Prompt Engineering\nUpdate system prompt:\n\"When only a last name is provided, use author:\"^lastname\" format. Never guess initials.\"\n\n## Files to Review\n- `data/datasets/raw/gold_examples.json`\n- `data/datasets/processed/train.jsonl`\n- `packages/finetune/src/finetune/domains/scix/prompts.py`","status":"open","priority":1,"issue_type":"bug","created_at":"2026-01-21T11:33:33.324636-05:00","created_by":"sjarmak","updated_at":"2026-01-21T11:37:24.675526-05:00"}
{"id":"nls-finetune-scix-556","title":"Investigate slow model inference latency","description":"## Problem\nThe fine-tuned Qwen3-1.7B model takes noticeably long to return query translations, even though it's a small model that should be fast.\n\n## Expected Behavior\n- 1.7B parameter model should return in \u003c1 second\n- Cold start might be slower, but warm requests should be fast\n\n## Investigation Areas\n\n### 1. Modal Container Cold Starts\n- Check if container is spinning down between requests\n- Consider keep_warm setting in Modal deployment\n- Check `modal app logs` for startup times\n\n### 2. vLLM Configuration\n- Check if vLLM is configured optimally\n- Review `packages/finetune/src/finetune/modal/serve.py` settings\n- Consider tensor parallelism, quantization settings\n\n### 3. Network Latency\n- Test direct curl to Modal endpoint vs through Next.js proxy\n- Compare response times\n\n### 4. Request Overhead\n- Check if max_tokens=128 is appropriate\n- Review if streaming would improve perceived latency\n\n## Diagnostic Commands\n```bash\n# Direct endpoint test with timing\ntime curl -X POST https://sjarmak--nls-finetune-serve-vllm-serve.modal.run/v1/chat/completions \\\n  -H 'Content-Type: application/json' \\\n  -d '{\"model\":\"llm\",\"messages\":[{\"role\":\"system\",\"content\":\"Convert to ADS query. Output JSON: {\\\"query\\\":\\\"...\\\"}\"},{\"role\":\"user\",\"content\":\"Query: papers by Einstein\\nDate: 2026-01-21\"}],\"max_tokens\":128}'\n\n# Check Modal app status\nmodal app list\nmodal app logs sjarmak/nls-finetune-serve\n```\n\n## Files to Review\n- `packages/finetune/src/finetune/modal/serve.py` - vLLM serving config\n- `~/ads-dev/nectar/src/pages/api/nl-search.ts` - proxy timing","status":"open","priority":1,"issue_type":"task","created_at":"2026-01-21T11:29:58.869966-05:00","created_by":"sjarmak","updated_at":"2026-01-21T11:29:58.869966-05:00"}
{"id":"nls-finetune-scix-6kk","title":"Model inconsistently selects title: vs abs: fields","description":"## Problem\nModel inconsistently chooses between `title:` and `abs:` for topic searches.\n\n## Examples\n| Input | Output | Issue |\n|-------|--------|-------|\n| \"papers about code intelligence\" | `title:\"code intelligence\"` | title only, misses abstracts |\n| \"papers about machine learning\" | `abs:\"machine learning\"` | OK but inconsistent |\n| \"papers about machine learning\" | `abs:\"ML\"` | Converted to abbreviation, loses results |\n\n## Impact\n- Inconsistent behavior confuses users\n- `title:` only misses papers where term is in abstract\n- Abbreviations like \"ML\" for \"machine learning\" reduce recall\n\n## Potential Fixes\n\n### 1. Training Data Standardization\nStandardize on `abs:` for topic queries (broader coverage):\n- \"papers about X\" → `abs:\"X\"`\n- Or use `(title:\"X\" OR abs:\"X\")` for comprehensive search\n\n### 2. Avoid Abbreviation Conversion\nAdd training examples that preserve full terms:\n- \"machine learning\" should stay \"machine learning\", not become \"ML\"\n- \"artificial intelligence\" should not become \"AI\"\n\n### 3. Post-Processing Rules\nIf model outputs abbreviation, expand it back\n\n## Related\n- See eval-004 for author initial hallucination\n- Part of broader model quality improvements","status":"open","priority":2,"issue_type":"bug","created_at":"2026-01-21T11:39:59.851011-05:00","created_by":"sjarmak","updated_at":"2026-01-21T11:39:59.851011-05:00"}
{"id":"nls-finetune-scix-92o","title":"Phase 0: Bootstrap nls-finetune-scix repository","description":"Copy ~/nls-query-finetune to ~/nls-finetune-scix, rename Sourcegraph references to SciX/ADS, update .env.example for ADS API keys, stub domains/scix folder. Keep same monorepo layout (mise, uv, Bun/Vite).","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-20T17:26:39.477861-05:00","created_by":"sjarmak","updated_at":"2026-01-20T20:07:42.708706-05:00","closed_at":"2026-01-20T20:07:42.708706-05:00","close_reason":"Bootstrapped nls-finetune-scix repository: copied infrastructure from nls-query-finetune, renamed to scix-finetune CLI, updated for ADS/SciX domain, created domains/scix module with fields.py, validate.py, prompts.py, eval.py stubs."}
{"id":"nls-finetune-scix-ew6","title":"Phase 1: ADS query validator + dataset integration","description":"Create domains/scix/validate.py with: (1) API-backed validator calling ADS Search API with rows=0, (2) offline linter for quick regex checks (unbalanced quotes, invalid fields, bad ranges). Update validate_dataset.py to use new validator. Replace nls_query_eval binary dependency.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-20T17:26:48.822384-05:00","created_by":"sjarmak","updated_at":"2026-01-20T21:14:16.775599-05:00","closed_at":"2026-01-20T21:14:16.775599-05:00","close_reason":"Completed Phase 1: ADS query validator + dataset integration. (1) Tested offline linter with valid/invalid ADS queries - all pass. (2) Tested validate_nl() for ADS syntax leakage detection. (3) Updated validate_dataset.py to use lint_query from finetune.domains.scix instead of nls_query_eval binary. Features domain-002, domain-004, data-003 now passing.","dependencies":[{"issue_id":"nls-finetune-scix-ew6","depends_on_id":"nls-finetune-scix-92o","type":"blocks","created_at":"2026-01-20T17:26:48.824396-05:00","created_by":"daemon"}]}
{"id":"nls-finetune-scix-f2w","title":"Phase 5: SciXplorer UI/API integration","description":"Update web UI for SciX workflow: NL input → suggested ADS query → copy/apply button. Add optional preview result count via backend proxy. Deploy as complementary feature to existing search bar (behind feature flag).","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-20T17:27:12.414208-05:00","created_by":"sjarmak","updated_at":"2026-01-20T17:27:12.414208-05:00","dependencies":[{"issue_id":"nls-finetune-scix-f2w","depends_on_id":"nls-finetune-scix-jhk","type":"blocks","created_at":"2026-01-20T17:27:12.416594-05:00","created_by":"daemon"},{"issue_id":"nls-finetune-scix-f2w","depends_on_id":"nls-finetune-scix-ybr","type":"blocks","created_at":"2026-01-20T17:27:12.417653-05:00","created_by":"daemon"}]}
{"id":"nls-finetune-scix-f42","title":"Feature: Return multiple query suggestions (3-5 alternatives)","description":"## Feature Request\nInstead of returning a single query, return 3-5 alternative queries that capture different interpretations of the user's intent.\n\n## Example\nInput: \"papers about exoplanet atmospheres\"\n\n**Current behavior:**\n```json\n{\"query\": \"abs:\\\"exoplanet atmospheres\\\"\"}\n```\n\n**Proposed behavior:**\n```json\n{\n  \"queries\": [\n    {\"query\": \"abs:\\\"exoplanet atmospheres\\\"\", \"description\": \"Exact phrase in abstract\"},\n    {\"query\": \"abs:(exoplanet AND atmospheres)\", \"description\": \"Both terms in abstract\"},\n    {\"query\": \"title:\\\"exoplanet atmospheres\\\"\", \"description\": \"Exact phrase in title\"},\n    {\"query\": \"abs:(exoplanet AND (atmosphere OR atmospheres OR atmospheric))\", \"description\": \"With synonyms\"},\n    {\"query\": \"keyword:\\\"exoplanets\\\" abs:atmosphere\", \"description\": \"Using keywords field\"}\n  ]\n}\n```\n\n## Benefits\n- Users can choose the query that best matches their intent\n- Teaches users about ADS query syntax\n- Reduces frustration from single \"wrong\" suggestion\n- Handles ambiguous queries gracefully\n\n## Implementation Options\n\n### Option A: Model generates multiple\n- Train model to output JSON array of queries\n- Pro: Model learns query variations\n- Con: Increases token output, latency\n\n### Option B: Post-process single query\n- Model outputs one query, backend generates variations\n- Pro: Faster, deterministic\n- Con: Rule-based, less flexible\n\n### Option C: Hybrid\n- Model outputs primary query + intent classification\n- Backend generates variations based on intent\n- Pro: Best of both\n\n## UI Changes Needed\n- Update NLSearch component to display multiple options\n- Add radio buttons or clickable chips\n- Show description/explanation for each option\n\n## Files to Modify\n- `~/ads-dev/nectar/src/pages/api/nl-search.ts`\n- `~/ads-dev/nectar/src/components/NLSearch/index.tsx`\n- `~/ads-dev/nectar/src/components/NLSearch/useNLSearch.ts`\n- Training data if using Option A","status":"open","priority":2,"issue_type":"feature","created_at":"2026-01-21T11:40:15.168875-05:00","created_by":"sjarmak","updated_at":"2026-01-21T11:40:15.168875-05:00"}
{"id":"nls-finetune-scix-h1y","title":"Result count preview broken - /api/search returns 404","description":"## Problem\nThe NL Search result count preview doesn't work because `/api/search` returns 404.\n\n## Root Cause\n- `useNLSearch.ts:111` calls `/api/search?q=...\u0026rows=0\u0026fl=bibcode`\n- The `src/pages/api/search/` directory exists but is EMPTY\n- The API route was never created during integ-004\n\n## Evidence\nNetwork requests show:\n- `/api/nl-search` → 200 ✅ (query generation works)\n- `/api/search?q=abs%3A%22exoplanets%22\u0026rows=0\u0026fl=bibcode` → 404 ❌\n\n## Fix Required\nCreate `src/pages/api/search/index.ts` that proxies to the ADS search API:\n- Accept GET requests with `q`, `rows`, `fl` params\n- Proxy to `https://api.adsabs.harvard.edu/v1/search/query`\n- Use session token for authentication (see other API routes for pattern)\n- Return JSON with `response.numFound`\n\n## Files to Modify\n- `~/ads-dev/nectar/src/pages/api/search/index.ts` (create)\n\n## Verification\n1. Run `pnpm dev` with `NEXT_PUBLIC_NL_SEARCH=enabled`\n2. Type a natural language query\n3. Result count should appear next to suggested query (e.g., '~1.2K results')","status":"open","priority":1,"issue_type":"bug","created_at":"2026-01-21T11:20:30.15205-05:00","created_by":"sjarmak","updated_at":"2026-01-21T11:20:52.832311-05:00"}
{"id":"nls-finetune-scix-jhk","title":"Phase 3: Train + inference with validation retry","description":"Run Modal LoRA training on Qwen3-1.7B with updated prompts. Deploy inference endpoint. Add post-generation validation: check JSON output validity, validate ADS query syntax, optionally retry with error message on failure.","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-20T17:26:59.810813-05:00","created_by":"sjarmak","updated_at":"2026-01-20T17:26:59.810813-05:00","dependencies":[{"issue_id":"nls-finetune-scix-jhk","depends_on_id":"nls-finetune-scix-ew6","type":"blocks","created_at":"2026-01-20T17:26:59.81299-05:00","created_by":"daemon"},{"issue_id":"nls-finetune-scix-jhk","depends_on_id":"nls-finetune-scix-16z","type":"blocks","created_at":"2026-01-20T17:26:59.814783-05:00","created_by":"daemon"}]}
{"id":"nls-finetune-scix-mtt","title":"Research: Query expansion via embeddings + database constraints","description":"## Research Question\nShould we enhance query translation with:\n1. Semantic embeddings for query expansion (synonyms, related terms)\n2. Database constraints (validate authors/titles exist in ADS)\n\n## Semantic Query Expansion\n\n### Problem\n- \"machine learning\" → \"ML\" loses results\n- \"exoplanet\" might miss \"extrasolar planet\"\n- Domain-specific synonyms not captured\n\n### Potential Approach\n1. Use embedding model to find semantically similar terms\n2. Expand query with OR clauses for synonyms\n3. Example: `abs:(\"machine learning\" OR \"ML\" OR \"deep learning\")`\n\n### Concerns\n- Adds complexity and latency\n- May over-expand and reduce precision\n- Requires embedding model deployment\n\n## Database Constraints\n\n### Idea\nValidate generated queries against ADS:\n- Author names: Check if author exists in database\n- Suggest corrections: \"jarmak\" → \"Jarmak, S.\" (real author)\n- Paper titles: Fuzzy match against existing titles\n\n### Benefits\n- Better author disambiguation\n- Fewer zero-result queries\n- Could provide autocomplete data\n\n### Concerns\n- **Latency**: Each query needs ADS API call for validation\n- **Training data size**: ADS has millions of papers/authors\n- **Staleness**: New papers/authors won't be in training data\n- **Overwhelming model**: Too much data may hurt generalization\n\n## Recommendation\nStart with simpler approaches first:\n1. Fix current model quality issues (eval-004, nls-finetune-scix-6kk)\n2. Add multiple query suggestions (nls-finetune-scix-f42)\n3. Evaluate if semantic expansion is still needed\n4. Database constraints could be runtime API, not training data\n\n## Questions to Answer\n- What's acceptable latency for query suggestions?\n- How much does query expansion actually help recall?\n- Can we use ADS's existing autocomplete API instead of training?\n\n## Related Issues\n- nls-finetune-scix-3gw (author initials)\n- nls-finetune-scix-6kk (field selection)\n- nls-finetune-scix-f42 (multiple suggestions)","status":"open","priority":3,"issue_type":"task","created_at":"2026-01-21T11:40:30.235995-05:00","created_by":"sjarmak","updated_at":"2026-01-21T11:40:30.235995-05:00"}
{"id":"nls-finetune-scix-ybr","title":"Phase 4: Evaluation harness for ADS queries","description":"Implement domains/scix/eval.py with: (1) syntactic validity rate, (2) result-set overlap metrics via ADS API (Jaccard, Precision@N), (3) feature-sliced reporting (author, pubdate, bibstem, object queries). Output JSON artifacts to data/datasets/evaluations/.","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-20T17:27:07.218765-05:00","created_by":"sjarmak","updated_at":"2026-01-20T17:27:07.218765-05:00","dependencies":[{"issue_id":"nls-finetune-scix-ybr","depends_on_id":"nls-finetune-scix-ew6","type":"blocks","created_at":"2026-01-20T17:27:07.220872-05:00","created_by":"daemon"},{"issue_id":"nls-finetune-scix-ybr","depends_on_id":"nls-finetune-scix-jhk","type":"blocks","created_at":"2026-01-20T17:27:07.221928-05:00","created_by":"daemon"}]}
