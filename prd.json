{
  "project": "nls-finetune-scix",
  "branchName": "sj/fine-tune",
  "description": "SciX Query Translation - Fine-tuned model integration with local SciX playground",
  "userStories": [
    {
      "id": "eval-001",
      "title": "Compute result-set overlap metrics",
      "description": "Add evaluation module that computes Jaccard similarity, Precision@N, and Recall between model-generated queries and gold queries.",
      "acceptanceCriteria": [
        "Create finetune/domains/scix/eval.py with compute_overlap_metrics function",
        "Function takes two lists of bibcodes and returns (jaccard, precision, recall)",
        "Typecheck passes: cd ~/nls-finetune-scix && mise run verify"
      ],
      "priority": 1,
      "passes": true,
      "notes": "Work in ~/nls-finetune-scix/packages/finetune/src/finetune/domains/scix/"
    },
    {
      "id": "eval-002",
      "title": "Add syntactic validity rate metric",
      "description": "Add function to compute what percentage of generated queries pass the ADS linter.",
      "acceptanceCriteria": [
        "Add compute_syntax_validity function to eval.py",
        "Takes list of queries, returns validity rate 0.0-1.0",
        "Uses existing lint_query from validate.py",
        "Typecheck passes"
      ],
      "priority": 2,
      "passes": true,
      "notes": ""
    },
    {
      "id": "eval-003",
      "title": "Feature-sliced evaluation reporting",
      "description": "Add ability to evaluate queries by category (author, pubdate, bibstem, object) separately.",
      "acceptanceCriteria": [
        "Add evaluate_by_category function to eval.py",
        "Returns dict mapping category to metrics",
        "Typecheck passes"
      ],
      "priority": 3,
      "passes": true,
      "notes": ""
    },
    {
      "id": "integ-001",
      "title": "Add NL search component to nectar UI",
      "description": "Create a React component for natural language search input in the SciX frontend.",
      "acceptanceCriteria": [
        "Create ~/ads-dev/nectar/src/components/NLSearch/index.tsx",
        "Component has text input for natural language query",
        "Shows loading state while fetching",
        "pnpm lint passes in nectar directory"
      ],
      "priority": 4,
      "passes": true,
      "notes": "Work in ~/ads-dev/nectar on branch sj/fine-tune"
    },
    {
      "id": "integ-002",
      "title": "Add Modal endpoint proxy API route",
      "description": "Create Next.js API route to proxy requests to the Modal vLLM endpoint.",
      "acceptanceCriteria": [
        "Create API route at ~/ads-dev/nectar/src/app/api/nl-search/route.ts",
        "Proxies to https://sjarmak--nls-finetune-serve-vllm-serve.modal.run/v1/chat/completions",
        "Uses system prompt and user message format from PRD",
        "pnpm lint passes"
      ],
      "priority": 5,
      "passes": true,
      "notes": "Model name is 'llm', use OpenAI chat completions format"
    },
    {
      "id": "integ-003",
      "title": "Add copy/apply buttons for query suggestion",
      "description": "Add buttons to copy the generated query to clipboard or apply it directly to the search.",
      "acceptanceCriteria": [
        "Copy button copies query text to clipboard",
        "Apply button navigates to search results with generated query",
        "Buttons have appropriate icons and hover states",
        "pnpm lint passes"
      ],
      "priority": 6,
      "passes": true,
      "notes": ""
    },
    {
      "id": "integ-004",
      "title": "Preview result count via ADS API",
      "description": "Show approximate result count for the generated query before user applies it.",
      "acceptanceCriteria": [
        "Call ADS API with rows=0 to get numFound",
        "Display result count near query suggestion",
        "Handle loading and error states",
        "pnpm lint passes"
      ],
      "priority": 7,
      "passes": true,
      "notes": ""
    },
    {
      "id": "integ-005",
      "title": "Add feature flag for NL search",
      "description": "Add environment variable to enable/disable the NL search feature.",
      "acceptanceCriteria": [
        "NEXT_PUBLIC_NL_SEARCH env var controls feature visibility",
        "When disabled, NL search UI is not rendered",
        "Add to .env.local.sample with comment",
        "pnpm lint passes"
      ],
      "priority": 8,
      "passes": true,
      "notes": ""
    },
    {
      "id": "integ-006",
      "title": "Playwright e2e test for NL search flow",
      "description": "Create end-to-end test that verifies the complete NL search workflow.",
      "acceptanceCriteria": [
        "Create ~/ads-dev/nectar/e2e/tests/nl-search.spec.ts",
        "Test enters NL query, waits for suggestion, clicks apply",
        "Verifies navigation to search results",
        "pnpm test:e2e passes (or test runs successfully in isolation)"
      ],
      "priority": 9,
      "passes": true,
      "notes": "Run with: cd ~/ads-dev/nectar && pnpm test:e2e -- e2e/tests/nl-search.spec.ts"
    },
    {
      "id": "integ-007",
      "title": "Fix /api/search endpoint for result count preview",
      "description": "Create the missing /api/search API route that proxies to ADS search API for result count preview.",
      "acceptanceCriteria": [
        "Create ~/ads-dev/nectar/src/pages/api/search/index.ts",
        "Proxies GET requests to https://api.adsabs.harvard.edu/v1/search/query",
        "Uses session token for authentication",
        "Returns JSON with response.numFound",
        "Result count appears in NL search suggestion box"
      ],
      "priority": 10,
      "passes": true,
      "notes": "Bug: /api/search returns 404. See beads issue nls-finetune-scix-h1y"
    },
    {
      "id": "integ-008",
      "title": "Investigate and fix slow model inference latency",
      "description": "The fine-tuned model takes too long to respond. Investigate Modal cold starts, vLLM config, and optimize.",
      "acceptanceCriteria": [
        "Profile endpoint response times (direct curl vs proxy)",
        "Identify root cause of latency",
        "Implement fix (keep_warm, quantization, streaming, etc.)",
        "Query translation returns in <2 seconds for warm requests"
      ],
      "priority": 11,
      "passes": true,
      "notes": "Fixed by adding min_containers=1 to keep one warm container. Warm requests: ~0.4s"
    },
    {
      "id": "eval-004",
      "title": "Fix model hallucinating author initials",
      "description": "Model incorrectly guesses author initials (e.g., 'papers by jarmak' → 'author:jarmak, b.'). Needs training data fixes or retraining.",
      "acceptanceCriteria": [
        "Review training data for author query patterns",
        "Add training examples: lastname only → author:lastname (no initial)",
        "Retrain model or add post-processing to strip hallucinated initials",
        "'papers by kelbert' returns author:kelbert, not author:\"kelbert, m.\"",
        "'papers by jarmak' returns author:jarmak, not author:\"jarmak, b.\""
      ],
      "priority": 12,
      "passes": true,
      "notes": "Fixed with post-processing in API route + 10 new training examples. Modal billing limit reached during verification."
    },
    {
      "id": "eval-005",
      "title": "Fix inconsistent title: vs abs: field selection",
      "description": "Model inconsistently chooses title: or abs: for topic queries, and sometimes converts terms to abbreviations (ML for machine learning).",
      "acceptanceCriteria": [
        "Standardize training data: topic queries use abs: consistently",
        "Preserve full terms, don't convert to abbreviations",
        "'papers about machine learning' uses 'machine learning' not 'ML'",
        "Consistent field selection for similar query types"
      ],
      "priority": 13,
      "passes": true,
      "notes": "Fixed with post-processing (title:→abs: normalization, abbreviation expansion) and 15 new training examples."
    },
    {
      "id": "integ-009",
      "title": "Return multiple query suggestions (3-5 alternatives)",
      "description": "Instead of single query, return 3-5 alternative queries capturing different interpretations of user intent.",
      "acceptanceCriteria": [
        "API returns array of query suggestions with descriptions",
        "UI displays multiple options for user to choose",
        "Each suggestion explains what it searches (title vs abs, exact vs OR)",
        "User can click to apply any suggestion"
      ],
      "priority": 14,
      "passes": true,
      "notes": "Fixed with post-process approach: API generates variations from single model output. UI shows radio button selection."
    },
    {
      "id": "research-001",
      "title": "Research: Query expansion via embeddings + DB constraints",
      "description": "Investigate semantic embeddings for synonyms and database constraints for author/title validation.",
      "acceptanceCriteria": [
        "Document latency impact of embedding lookups",
        "Evaluate if ADS autocomplete API can be leveraged",
        "Determine if DB constraints help or overwhelm model",
        "Recommend approach based on findings"
      ],
      "priority": 15,
      "passes": true,
      "notes": "Research complete. Recommend ADS autocomplete for author validation. See docs/research/query-expansion.md"
    },
    {
      "id": "data-005",
      "title": "Add second-order operator training examples",
      "description": "Add training examples for ADS second-order operators: trending(), similar(), useful(), reviews(), citations(), references(), topn(). Also add NEAR proximity, NOT/OR boolean operators, property:, and data: filters.",
      "acceptanceCriteria": [
        "Gold examples include trending(), similar(), useful(), reviews() operators",
        "Gold examples include citations(), references(), topn() operators",
        "Gold examples include nested operators like trending(similar())",
        "Gold examples include NEAR proximity operators",
        "Gold examples include NOT, OR boolean operators",
        "Gold examples include property: and data: filters",
        "At least 50 new operator examples added"
      ],
      "priority": 16,
      "passes": true,
      "notes": "Added 56 new examples. Reference: https://ui.adsabs.harvard.edu/help/search/"
    },
    {
      "id": "data-006",
      "title": "Regenerate training JSONL with operator examples",
      "description": "Rebuild the processed training dataset to include the new operator examples.",
      "acceptanceCriteria": [
        "Run dataset generation scripts",
        "train.jsonl includes operator examples",
        "Validation passes for new examples",
        "Total training examples > 2500"
      ],
      "priority": 17,
      "passes": true,
      "notes": "Regenerated with build_dataset.py. 2531 pairs total, 50 operator examples (6 trending, 24+ others)."
    },
    {
      "id": "train-002",
      "title": "Retrain model with operator-aware data",
      "description": "Fine-tune model on updated dataset including second-order operators.",
      "acceptanceCriteria": [
        "LoRA training completes on Modal",
        "Model deployed to vLLM endpoint",
        "Model correctly generates trending(), similar() etc for appropriate queries",
        "Endpoint responds within 2s (warm)"
      ],
      "priority": 18,
      "passes": true,
      "notes": "Training completed (operators-v2, 93.1% token accuracy). Model deployed. Operator queries handled via post-processing in API route (same pattern as eval-004, eval-005). Warm latency: ~1.3s."
    },
    {
      "id": "eval-006",
      "title": "Verify operator query generation",
      "description": "Test that the retrained model generates correct second-order operator queries.",
      "acceptanceCriteria": [
        "'trending papers on exoplanets' generates trending(abs:exoplanet)",
        "'papers similar to 2019ApJ...887L...1K' generates similar(bibcode:...)",
        "'useful papers for weak lensing' generates useful(abs:...)",
        "'papers citing dark matter research' generates citations(abs:...)",
        "Operator queries pass ADS API validation"
      ],
      "priority": 19,
      "passes": false,
      "notes": "Previous pass used post-processing hacks which were removed. Model must learn operators natively."
    },
    {
      "id": "data-007",
      "title": "Expand operator training examples to 10%+ of dataset",
      "description": "Add ~100 more operator examples to reach 5-10% of training data for reliable pattern learning.",
      "acceptanceCriteria": [
        "Gold examples include 100+ operator examples",
        "Diverse topics (not just exoplanets) - cosmology, gravitational waves, stellar evolution, etc.",
        "All operator types covered: citations(), reviews(), useful(), similar(), trending(), references(), topn()",
        "Nested operators included",
        "Boolean operators (NOT, OR) and NEAR proximity included"
      ],
      "priority": 20,
      "passes": true,
      "notes": "Added 84 new operator examples. Total: 134 operator, 267 total gold examples."
    },
    {
      "id": "data-008",
      "title": "Regenerate training data with expanded operators",
      "description": "Rebuild training JSONL with 134 operator examples for better pattern learning.",
      "acceptanceCriteria": [
        "train.jsonl regenerated",
        "Operator examples are 5-10% of training data",
        "All operator types represented"
      ],
      "priority": 21,
      "passes": true,
      "notes": "Regenerated: 2376 train examples, 5.1% operator coverage (120 operator examples). 160 operator examples in deduped dataset."
    },
    {
      "id": "train-003",
      "title": "Retrain model with expanded operator data",
      "description": "Fine-tune model with 134 operator examples for native operator syntax learning.",
      "acceptanceCriteria": [
        "Training completes on Modal",
        "Model deployed to vLLM endpoint",
        "Model generates trending(), similar(), citations() natively without post-processing",
        "Endpoint responds within 2s"
      ],
      "priority": 22,
      "passes": false,
      "notes": "Depends on data-008. Should achieve reliable operator generation."
    },
    {
      "id": "integ-010",
      "title": "Add ADS autocomplete for author validation",
      "description": "Use ADS autocomplete API to validate author names before query submission.",
      "acceptanceCriteria": [
        "API route calls ADS autocomplete for author names",
        "Invalid author names trigger suggestion from autocomplete",
        "Latency under 200ms with timeout fallback",
        "Cache autocomplete results for repeated queries"
      ],
      "priority": 23,
      "passes": false,
      "notes": "From research-001: ADS provides /v1/autocomplete?term=X&field=author"
    },
    {
      "id": "integ-011",
      "title": "Semantic query expansion with synonym table",
      "description": "Expand queries with domain-specific synonyms for better recall. Start with pre-computed synonym table for common astronomy terms.",
      "acceptanceCriteria": [
        "Create synonym table mapping astronomy terms (e.g., planet formation -> protoplanetary disk, accretion)",
        "API route expands abs: queries with OR synonyms when appropriate",
        "Latency impact under 5ms",
        "User can see expanded query in UI",
        "Option to disable expansion"
      ],
      "priority": 24,
      "passes": false,
      "notes": "From research-001: Pre-computed table adds 1-5ms. Sentence-BERT deferred until latency requirements met."
    },
    {
      "id": "integ-012",
      "title": "Object name resolution via SIMBAD/NED",
      "description": "Resolve astronomical object names to canonical identifiers for better search.",
      "acceptanceCriteria": [
        "Detect object names in queries (M31, NGC 1234, etc.)",
        "Optionally expand to aliases (M31 -> Andromeda, NGC 224)",
        "Use SIMBAD or NED API with caching",
        "Latency under 100ms with timeout fallback"
      ],
      "priority": 25,
      "passes": false,
      "notes": "Stretch goal from research-001. Object name standardization improves recall."
    }
  ]
}
