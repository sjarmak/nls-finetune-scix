{
  "project": "NLS Fine-tune SciX",
  "branchName": "improve-training-data",
  "description": "Improve training data quality and post-processing validation using ADS field constraints and metadata",
  "userStories": [
    {
      "id": "US-001",
      "title": "Create ADS field constraints module",
      "description": "As a developer, I need enumerated field values from ADS API schema so the system can validate queries at inference time.",
      "acceptanceCriteria": [
        "Create packages/finetune/src/finetune/domains/scix/field_constraints.py with FIELD_ENUMS dict",
        "Include all 16+ doctypes: article, eprint, book, phdthesis, proposal, software, etc.",
        "Include all 19+ properties: refereed, openaccess, data, notrefereed, etc.",
        "Include 3 databases: ASTRONOMY, PHYSICS, GENERAL",
        "Include bibgroup values from ADS (30+ institutional/telescope groups)",
        "Include esources enum (PUB_PDF, EPRINT_PDF, AUTHOR_PDF, etc.)",
        "Add docstrings with ADS schema sources",
        "Run: mise run lint and verify no errors"
      ],
      "priority": 1,
      "passes": true,
      "notes": "Reference: ADS montysolr schema.xml and GitHub.com/adsabs documentation"
    },
    {
      "id": "US-002",
      "title": "Add query constraint validation function",
      "description": "As a system, I need to validate generated queries against field constraints to catch invalid field combinations.",
      "acceptanceCriteria": [
        "Create validate.py function: validate_field_constraints(query: str) -> ValidationResult",
        "Check all doctype: values against FIELD_ENUMS['doctype']",
        "Check all database: values against FIELD_ENUMS['database']",
        "Check all property: values against FIELD_ENUMS['property']",
        "Check all bibgroup: values against FIELD_ENUMS['bibgroup']",
        "Return list of invalid fields with suggestions for correction",
        "Add unit tests in test_validate.py for 10+ queries (valid and invalid)",
        "Run: mise run test and all tests pass"
      ],
      "priority": 2,
      "passes": true,
      "notes": "Use existing lint_query as base, extend with constraint checking"
    },
    {
      "id": "US-003",
      "title": "Implement post-processing filter for model output",
      "description": "As a system, I need to clean up model-generated queries by removing invalid field combinations and enforcing constraints.",
      "acceptanceCriteria": [
        "Create function: constrain_query_output(query: str) -> str",
        "Remove any doctype/database/property values not in FIELD_ENUMS",
        "Log warnings for removed invalid fields",
        "Preserve valid field combinations (e.g., doctype:article AND property:refereed)",
        "Handle edge cases: empty fields, trailing operators, malformed parentheses",
        "Add 15+ test cases covering common model hallucinations",
        "Run: mise run test and verify all tests pass"
      ],
      "priority": 2,
      "passes": true,
      "notes": "This is the safety net to prevent model from outputting nonsense like 'bibstem:phdthesis'"
    },
    {
      "id": "US-004",
      "title": "Audit and fix remaining bare fields in training data",
      "description": "As a developer, I need to ensure all author/abs/title fields are properly quoted to teach the model correct syntax.",
      "acceptanceCriteria": [
        "Run audit script: python scripts/audit_bare_fields.py",
        "Find all remaining unquoted bare fields (45 identified from previous audit)",
        "Fix in all_pairs.json and gold_examples.json",
        "Verify queries pass validate.py lint_query with no errors",
        "Document count of fixed fields in commit message",
        "Run: mise run verify to confirm no regressions"
      ],
      "priority": 1,
      "passes": true,
      "notes": "45 bare fields remain from previous fix (mostly in complex expressions like author:(...))"
    },
    {
      "id": "US-005",
      "title": "Create training data quality report",
      "description": "As a project manager, I need a comprehensive report of training data quality metrics and issues.",
      "acceptanceCriteria": [
        "Generate report: data/datasets/QUALITY_REPORT.md",
        "Total pairs: count and breakdown by category",
        "Validation pass rate: % of pairs that pass lint_query",
        "Invalid fields report: list of invalid doctype/database/property/bibgroup values found",
        "Bare field summary: count of unquoted fields by type",
        "Examples section: show 5 'good' and 5 'bad' examples from training data",
        "Recommendations: list of top 5 improvements needed",
        "Include before/after metrics from this task"
      ],
      "priority": 3,
      "passes": true,
      "notes": "Use for presentation and tracking progress"
    },
    {
      "id": "US-006",
      "title": "Integrate field constraints into API validation layer",
      "description": "As an API, I need to apply field constraints to model output before returning to user.",
      "acceptanceCriteria": [
        "Update ~/ads-dev/nectar/src/pages/api/nl-search.ts to use constrain_query_output",
        "Call new constraint validation after model inference, before ADS API call",
        "Log all corrections made for debugging",
        "Return constraint violation details to frontend if violations detected",
        "Test with 10+ real queries that have field constraint issues",
        "Run: npm run build and npm run test in ads-dev/nectar"
      ],
      "priority": 3,
      "passes": false,
      "notes": "Cross-repo change - coordinate with ads-dev project structure"
    },
    {
      "id": "US-007",
      "title": "Document field constraint patterns in AGENTS.md",
      "description": "As a future developer, I need to understand ADS field constraints and how the model learns them.",
      "acceptanceCriteria": [
        "Update AGENTS.md with ADS Field Constraints section",
        "Document all FIELD_ENUMS values and their meanings",
        "Explain why bare fields are problematic (model learns to not quote)",
        "Show example of good vs bad training pairs for each field type",
        "Include links to ADS documentation sources",
        "List common model hallucinations and how constrain_query_output fixes them",
        "Add note about CanonicalAffiliations for future affiliation-based training"
      ],
      "priority": 3,
      "passes": false,
      "notes": "Knowledge base for future iterations"
    }
  ]
}
