{
  "project": "NLS Fine-tune SciX - Hybrid NER Pipeline",
  "branchName": "hybrid-ner-pipeline",
  "description": "Replace end-to-end generation with deterministic NER + few-shot retrieval + template assembly to eliminate malformed operator syntax",
  "userStories": [
    {
      "id": "US-001",
      "title": "Define IntentSpec dataclass and pipeline skeleton",
      "description": "As a developer, I need a typed IntentSpec and pipeline interface so each stage is testable independently.",
      "acceptanceCriteria": [
        "Create packages/finetune/src/finetune/domains/scix/intent_spec.py with IntentSpec dataclass",
        "IntentSpec fields: free_text_terms, authors, affiliations, objects, year_from, year_to",
        "IntentSpec fields: doctype, property, database, bibgroup, esources, data (all set[str])",
        "IntentSpec fields: operator (None | str from OPERATORS set), operator_target (optional)",
        "IntentSpec fields: raw_user_text, confidence (dict[str,float])",
        "Create pipeline.py with function: process_query(nl_text: str) -> PipelineResult",
        "PipelineResult contains: intent, retrieved_examples, final_query, debug_info",
        "Add unit tests: instantiate/serialize/deserialize IntentSpec",
        "Add unit tests: pipeline returns stable keys for sample inputs",
        "Run: mise run lint and mise run test - all pass"
      ],
      "priority": 1,
      "passes": true,
      "notes": "Foundation for all other stories. No LLM call in default path."
    },
    {
      "id": "US-002",
      "title": "Implement rules-based NER with strict operator gating",
      "description": "As a user, I want 'references/citing' words to not break syntax unless I explicitly ask for operator behavior.",
      "acceptanceCriteria": [
        "Create packages/finetune/src/finetune/domains/scix/ner.py with extract_intent(text: str) -> IntentSpec",
        "Normalize input: lowercase for matching, preserve original spans for quoting",
        "Detect if user already provided ADS query (contains field: tokens) - skip NER if so",
        "Enum constraint extraction with synonym maps:",
        "  - 'refereed', 'peer reviewed' → property:refereed",
        "  - 'open access', 'oa' → property:openaccess",
        "  - 'arxiv', 'preprint' → property:eprint OR doctype:eprint",
        "  - telescope aliases: 'Hubble' → bibgroup:HST, 'Webb' → bibgroup:JWST",
        "Year extraction: patterns for 'from X to Y', 'since X', 'before X', 'last N years'",
        "Author extraction: patterns for 'by <name>', 'author <name>', 'first author <name>'",
        "CRITICAL - Operator gating (only set operator when explicit):",
        "  - citations: 'cited by', 'papers citing', 'who cited'",
        "  - references: 'references of', 'papers referenced by', 'bibliography of'",
        "  - similar: 'similar to this paper', 'like <paper>'",
        "  - trending/useful/reviews: 'trending papers', 'most useful', 'reviews of'",
        "  - Do NOT set operator for generic words like 'citing', 'references' alone",
        "All extracted enum values validated against FIELD_ENUMS",
        "Remainder becomes free_text_terms for abs:/title:",
        "Unit tests for positive/negative operator patterns",
        "Unit tests for synonym mapping for all enum types",
        "Run: mise run test - all pass"
      ],
      "priority": 1,
      "passes": true,
      "notes": "This is the core fix that prevents operator conflation. Operator gating is critical."
    },
    {
      "id": "US-003",
      "title": "Implement few-shot retrieval over gold_examples.json",
      "description": "As a developer, I want retrieval to return similar gold patterns quickly to guide query assembly.",
      "acceptanceCriteria": [
        "Create packages/finetune/src/finetune/domains/scix/retrieval.py",
        "Load gold_examples.json into in-memory index at startup",
        "Implement lightweight similarity scoring (token overlap / BM25-like)",
        "Boost score for matching: doctype, property, operator, year patterns, author tokens",
        "Function: retrieve_similar(intent: IntentSpec, k: int = 5) -> list[GoldExample]",
        "Return both gold query and feature summary for each example",
        "Retrieval time < 20ms for 400 examples (add performance test)",
        "Add unit tests for ranking stability (deterministic across runs)",
        "Add snapshot test for known inputs → expected top-k examples",
        "Run: mise run test - all pass"
      ],
      "priority": 2,
      "passes": true,
      "notes": "Retrieval provides pattern guidance for assembly, not direct query copying."
    },
    {
      "id": "US-004",
      "title": "Implement deterministic template assembler with strict validation",
      "description": "As a user, I want queries composed only of valid fields/operators/enums.",
      "acceptanceCriteria": [
        "Create packages/finetune/src/finetune/domains/scix/assembler.py",
        "Function: assemble_query(intent: IntentSpec, examples: list[GoldExample]) -> str",
        "Build base clauses (AND-joined):",
        "  - author:\"...\" for authors (properly quoted)",
        "  - abs:\"...\" for topic phrases (quote if multiword)",
        "  - pubdate:[YYYY-MM TO YYYY-MM] for year ranges",
        "  - property:(val1 OR val2) for properties (only FIELD_ENUMS values)",
        "  - doctype:X, database:X, bibgroup:X (only FIELD_ENUMS values)",
        "Operator wrap at the end: if IntentSpec.operator set, wrap entire base query",
        "  - citations(<base_query>), references(<base_query>), etc.",
        "  - Enforce at most ONE operator (no nesting)",
        "Assembler NEVER outputs unknown operators or unconstrained enum values",
        "Run constrain_query_output() as final safety net",
        "If validation drops >50% of constraints, fall back to simpler query and log warning",
        "Unit tests: assembled query matches expected for canonical inputs",
        "Fuzz test: random insertion of 'citations/references' in NL never produces malformed concatenations",
        "Run: mise run test - all pass"
      ],
      "priority": 1,
      "passes": true,
      "notes": "Assembler is deterministic and never generates arbitrary text."
    },
    {
      "id": "US-005",
      "title": "Implement optional LLM resolver for ambiguous paper references",
      "description": "As a user, I want 'papers citing the famous paper about X' to work without manual bibcodes.",
      "acceptanceCriteria": [
        "Create packages/finetune/src/finetune/domains/scix/resolver.py",
        "Function: resolve_paper_reference(query: str, context: str) -> Optional[str]",
        "LLM called ONLY when:",
        "  - operator requires target AND target not explicitly provided",
        "  - user says 'this paper', 'that famous paper', etc.",
        "LLM returns structured JSON: { 'paper_title_guess': str, 'bibcode_guess': str | null }",
        "Use ADS search endpoint to resolve bibcode deterministically (top by citations)",
        "If resolution fails, fall back to non-operator query and log reason",
        "Add gating logic tests: no LLM call for normal queries",
        "Integration test with mocked ADS response: bibcode selection is deterministic",
        "Add timeout handling: if LLM takes >300ms, skip and fall back",
        "Run: mise run test - all pass"
      ],
      "priority": 3,
      "passes": true,
      "notes": "LLM is fallback only. Most queries should not trigger this."
    },
    {
      "id": "US-006",
      "title": "Integrate pipeline into Nectar API endpoint",
      "description": "As an API consumer, I want the nl-search endpoint to use the new hybrid pipeline.",
      "acceptanceCriteria": [
        "Update ~/ads-dev/nectar/src/pages/api/nl-search.ts",
        "Import and call Python pipeline via existing Modal/API mechanism",
        "Replace direct model call with pipeline.process_query()",
        "Return pipeline debug_info to frontend for debugging",
        "Log all constraint corrections and retrieval matches",
        "Handle pipeline errors gracefully: fall back to simple topic search",
        "E2E latency p95 < 500ms for rule-based path",
        "Add TypeScript types for PipelineResult",
        "Run: cd ~/ads-dev/nectar && npm run build && npm run test",
        "Manual verification: test 3 queries in browser"
      ],
      "priority": 2,
      "passes": false,
      "notes": "Cross-repo change. Nectar consumes the pipeline output."
    },
    {
      "id": "US-007",
      "title": "Deploy pipeline to Modal with preloaded indexes",
      "description": "As a system, I need the pipeline deployed with preloaded gold examples for low latency.",
      "acceptanceCriteria": [
        "Update serve_vllm.py or create serve_pipeline.py",
        "Preload gold_examples.json index at container startup",
        "Preload synonym maps and FIELD_ENUMS at startup",
        "Expose /v1/query endpoint that accepts { nl_text: string }",
        "Return { query, intent, retrieved_examples, debug_info }",
        "Warm request latency < 200ms (no LLM path)",
        "Cold start < 3s (container with preloaded data)",
        "Run: modal deploy and verify endpoint live",
        "Curl test with 3 sample queries",
        "Log deployment timestamp in progress.txt"
      ],
      "priority": 2,
      "passes": false,
      "notes": "Preloading is critical for latency. No per-request file loading."
    },
    {
      "id": "US-008",
      "title": "Playwright UI tests for operator queries",
      "description": "As a QA process, I need automated browser tests to verify operator syntax is correct.",
      "acceptanceCriteria": [
        "Create tests/e2e/test_nl_search.py or tests/e2e/nl_search.spec.ts",
        "Prerequisites: nectar dev server running on localhost:8000",
        "Test cases (5 minimum):",
        "  1. 'refereed open access papers about JWST since 2022'",
        "     → verify: property:refereed, property:openaccess, abs:JWST, year range",
        "  2. 'papers citing Hubble deep field paper'",
        "     → verify: citations() operator wraps query, no citationsabs: pattern",
        "  3. 'references of the Planck 2018 cosmology paper'",
        "     → verify: references() operator, no malformed concatenation",
        "  4. 'trending papers on exoplanets'",
        "     → verify: trending(abs:...), balanced parentheses",
        "  5. 'papers about references in stellar spectra'",
        "     → verify: NO operator set (references is topic, not operator)",
        "Each test verifies:",
        "  - Generated query contains no citationsabs:/referencesabs: patterns",
        "  - Parentheses are balanced",
        "  - API returns 200 (results render)",
        "Regression test: known failure strings like 'citations(abs:referencesabs:...)' never appear",
        "Run: mise run test:e2e - all pass"
      ],
      "priority": 1,
      "passes": false,
      "notes": "These tests catch the original malformed operator bug. Run after every deploy."
    },
    {
      "id": "US-009",
      "title": "Regression test suite for known failure patterns",
      "description": "As a developer, I need tests that specifically catch the malformed operator patterns that caused this refactor.",
      "acceptanceCriteria": [
        "Create tests/regression/test_operator_conflation.py",
        "Test 10+ inputs that previously caused malformed output:",
        "  - 'citing papers' → should NOT produce citationsabs:",
        "  - 'reference materials' → should NOT produce referencesabs:",
        "  - 'papers about references' → should treat as topic, no operator",
        "  - 'useful citations' → should NOT produce usefulcitations(",
        "  - 'similar references' → should NOT produce similarreferences(",
        "For each test, verify pipeline output:",
        "  - No operator concatenation patterns (regex check)",
        "  - All parentheses balanced",
        "  - All enum values in FIELD_ENUMS",
        "Add tests for edge cases:",
        "  - Nested operator requests (should gracefully handle or reject)",
        "  - Empty input → valid empty/error response",
        "  - Already-ADS-syntax input → passthrough with validation only",
        "Run: mise run test - all pass"
      ],
      "priority": 1,
      "passes": false,
      "notes": "These tests are the acceptance criteria for the entire refactor."
    },
    {
      "id": "US-010",
      "title": "Performance benchmarks and latency verification",
      "description": "As a system owner, I need to verify the pipeline meets latency requirements.",
      "acceptanceCriteria": [
        "Create scripts/benchmark_pipeline.py",
        "Benchmark components individually:",
        "  - NER extraction: target < 10ms per query",
        "  - Retrieval: target < 20ms for k=5",
        "  - Assembly: target < 5ms per query",
        "  - Total pipeline (no LLM): target < 50ms local, < 200ms Modal",
        "Benchmark with 100 sample queries from gold_examples",
        "Report p50, p95, p99 latencies",
        "Add CI check: fail if p95 > 500ms",
        "Document results in docs/LATENCY_BENCHMARKS.md",
        "If LLM fallback used, report separately (expected: p95 < 1s)",
        "Run: mise run benchmark"
      ],
      "priority": 2,
      "passes": false,
      "notes": "Latency is a hard constraint. Pipeline must be faster than end-to-end model."
    },
    {
      "id": "US-011",
      "title": "Documentation and AGENTS.md updates",
      "description": "As a future developer, I need documentation of the new hybrid architecture.",
      "acceptanceCriteria": [
        "Update AGENTS.md with Hybrid Pipeline Architecture section",
        "Document IntentSpec fields and their purposes",
        "Document operator gating rules (when operators ARE vs ARE NOT set)",
        "Document synonym maps for enum values",
        "List known edge cases and how they're handled",
        "Add troubleshooting section for common issues",
        "Create docs/HYBRID_PIPELINE.md with:",
        "  - Architecture diagram (mermaid)",
        "  - Data flow explanation",
        "  - How to add new operators",
        "  - How to add new enum synonyms",
        "  - How to debug pipeline failures",
        "Update README.md with new architecture overview",
        "Run: mise run verify - docs build without errors"
      ],
      "priority": 3,
      "passes": false,
      "notes": "Documentation enables future iteration and onboarding."
    },
    {
      "id": "US-012",
      "title": "Final integration test and sign-off",
      "description": "As a project owner, I need final verification that all components work together.",
      "acceptanceCriteria": [
        "All previous stories (US-001 through US-011) marked passes: true",
        "Full E2E test: nectar UI → Modal pipeline → ADS API → results rendered",
        "Test 10 queries covering all features:",
        "  - Simple topic search",
        "  - Author search",
        "  - Year range search",
        "  - Property/doctype filtering",
        "  - Operator queries (citations, references, trending, similar, useful)",
        "  - Edge case: words like 'citing' as topic (no operator)",
        "Verify 0 malformed operator patterns in all outputs",
        "Latency meets requirements (p95 < 500ms)",
        "Create final report: docs/HYBRID_PIPELINE_LAUNCH.md",
        "  - Before/after comparison with end-to-end model",
        "  - Syntax validity improvement metrics",
        "  - Known limitations and future work",
        "Merge hybrid-ner-pipeline branch to main"
      ],
      "priority": 1,
      "passes": false,
      "notes": "This is the final gate. All acceptance criteria must pass."
    }
  ]
}
