# Ralph Progress Log - SciX Fine-tuning

Started: 2026-01-21

## Codebase Patterns

- Modal endpoint: https://sjarmak--nls-finetune-serve-vllm-serve.modal.run (model name: 'llm')
- System prompt: 'Convert natural language to ADS search query. Output JSON: {"query": "..."}'
- User message format: 'Query: {nl}\nDate: {date}'
- Integration work happens in ~/ads-dev/nectar on branch sj/fine-tune
- Playwright tests: cd ~/ads-dev/nectar && pnpm test:e2e
- For eval features: work in ~/nls-finetune-scix/packages/finetune/src/finetune/domains/scix/
- Verification: mise run verify (finetune) or pnpm lint && pnpm test (nectar)
- Use existing lint_query() from validate.py for syntax validation

## Completed Work (Pre-Ralph)

### Phase 0-2: Bootstrap, Domain, Data (CLOSED)
- Repository structure with monorepo layout
- finetune/domains/scix/fields.py - 40+ ADS field definitions
- finetune/domains/scix/validate.py - Offline linter + API validation
- finetune/domains/scix/prompts.py - Training/generation prompts
- 2,447 training pairs from gold (96), synthetic (505), NL pairs (2000)

### Phase 3: Training + Inference (CLOSED)
- LoRA training on Qwen3-1.7B (~12.5 min on H100, 93% token accuracy)
- vLLM inference endpoint deployed
- Training cost: ~$1.50

---

## Session Log

## 2026-01-21 - eval-001
- Verified compute_overlap_metrics function exists in finetune/domains/scix/eval.py
- Function computes Jaccard, Precision, and Recall from two bibcode lists
- Fixed TypeScript verification by installing packages/web dependencies (bun install)
- All acceptance criteria met, mise run verify passes
- Files changed: prd.json (marked eval-001 passes: true), features.json (status: passing)
- **Learnings for future iterations:**
  - packages/web dependencies need to be installed for TypeScript checks to pass
  - eval.py already had full implementation including fetch_bibcodes, evaluate_pair, summarize_results
---


## 2026-01-21 - eval-002
- Added `compute_syntax_validity` function to eval.py
- Function takes list of queries and returns validity rate 0.0-1.0
- Uses existing `lint_query` from validate.py for offline syntax checking
- Files changed: packages/finetune/src/finetune/domains/scix/eval.py, prd.json, features.json
- **Learnings for future iterations:**
  - `lint_query` does fast offline validation, `validate_query` calls ADS API
  - Branch sj/fine-tune doesn't exist in this repo, work continues on main
---

## 2026-01-21 - eval-003
- Added `evaluate_by_category` function to eval.py
- Returns dict mapping category name to metrics (total, valid, validity_rate, mean_jaccard, mean_precision, mean_recall)
- Groups EvalResult objects by their `category` field (author, pubdate, bibstem, object, etc.)
- Files changed: packages/finetune/src/finetune/domains/scix/eval.py, prd.json, features.json
- **Learnings for future iterations:**
  - EvalResult already has a `category` field for sliced analysis
  - summarize_results() already did category grouping in by_category dict - new function extracts this pattern
---

## 2026-01-21 - integ-001
- Created NLSearch component in ~/ads-dev/nectar/src/components/NLSearch/
- Component includes text input with debounced natural language query
- Shows loading spinner while fetching from /api/nl-search endpoint
- Displays suggested query in styled box with data-testid for testing
- Created useNLSearch hook for API call handling with AbortController
- Files changed: src/components/NLSearch/index.tsx, src/components/NLSearch/useNLSearch.ts
- **Learnings for future iterations:**
  - nectar uses Chakra UI for components
  - use-debounce library available for debouncing
  - Component patterns: forwardRef, displayName convention
  - API routes expected at /api/* path
---

## 2026-01-21 - integ-002
- Created Modal endpoint proxy API route at ~/ads-dev/nectar/src/pages/api/nl-search.ts
- Proxies POST requests to https://sjarmak--nls-finetune-serve-vllm-serve.modal.run/v1/chat/completions
- Uses system prompt: 'Convert natural language to ADS search query. Output JSON: {"query": "..."}'
- Parses JSON response from model with regex fallback for robustness
- Handles errors with proper HTTP status codes (400, 405, 500, 502)
- Files changed: src/pages/api/nl-search.ts
- **Learnings for future iterations:**
  - nectar uses Pages Router (src/pages/api/) not App Router (src/app/api/)
  - API routes follow NextApiRequest/NextApiResponse pattern
  - lint-staged runs on commit, fixing formatting automatically
---

## 2026-01-21 - integ-003
- Added copy/apply buttons to NLSearch component in nectar
- Copy button: Uses navigator.clipboard.writeText(), shows toast notification, changes icon to CheckIcon when copied
- Apply button: Navigates to /search with generated query via router.push using makeSearchParams
- Added data-testid attributes for e2e testing (nl-search-copy-btn, nl-search-apply-btn)
- Added onApplyQuery prop for custom apply behavior
- Files changed: ~/ads-dev/nectar/src/components/NLSearch/index.tsx
- **Learnings for future iterations:**
  - Use existing CopyButton patterns from @/components/CopyButton but simplified inline
  - makeSearchParams from @/utils/common/search formats query params correctly
  - react-icons/md provides MdPlayArrow for the apply button
  - Chakra UI useToast for success notifications
---
